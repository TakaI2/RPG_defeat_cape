# 要件定義書: ストーリー・メッセージウィンドウシステム

## 1. 概要

### 1.1 目的
RPGゲームにおいて、キャラクターの立ち絵とセリフを表示するメッセージウィンドウシステムを実装する。
また、ストーリーエディタを提供し、他のプロジェクトでも再利用可能な汎用システムとして設計する。

### 1.2 参考プロジェクト
- Repository: `https://github.com/TakaI2/RPG-Game.git`
- 参考システム: JSONベースのストーリースクリプト、タイプライター効果、立ち絵表示

### 1.3 スコープ
- メッセージウィンドウUI
- ストーリー再生エンジン
- ストーリーデータ形式（ScriptableObject + JSON）
- ストーリーエディタ（Unityエディタウィンドウ）

---

## 2. 機能要件

### 2.1 メッセージウィンドウ (MessageWindow)

| ID | 要件 | 優先度 |
|----|------|--------|
| MW-001 | キャラクター名を表示できる | 必須 |
| MW-002 | セリフテキストを表示できる | 必須 |
| MW-003 | タイプライター効果（1文字ずつ表示）をサポートする | 必須 |
| MW-004 | 立ち絵画像を表示できる（左/中央/右の位置指定可能） | 必須 |
| MW-005 | 立ち絵のフェードイン/アウト効果をサポートする | 高 |
| MW-006 | クリック/キー入力で次のセリフへ進められる | 必須 |
| MW-007 | タイプライター中にクリックで即時全文表示できる | 必須 |
| MW-008 | ウィンドウの表示/非表示を切り替えられる | 必須 |
| MW-009 | 複数行のセリフに対応する | 必須 |
| MW-010 | 立ち絵なしでセリフのみ表示もできる | 高 |

### 2.2 ストーリー再生エンジン (StoryPlayer)

| ID | 要件 | 優先度 |
|----|------|--------|
| SP-001 | ストーリーデータを読み込んで順次実行できる | 必須 |
| SP-002 | `say` コマンド: セリフ表示 | 必須 |
| SP-003 | `bg` コマンド: 背景画像変更 | 高 |
| SP-004 | `bgm.play` コマンド: BGM再生 | 高 |
| SP-005 | `bgm.stop` コマンド: BGM停止 | 高 |
| SP-006 | `se.play` コマンド: 効果音再生 | 中 |
| SP-007 | `wait` コマンド: 指定時間待機 | 中 |
| SP-008 | `end` コマンド: ストーリー終了 | 必須 |
| SP-009 | ストーリー開始/終了イベントを発行できる | 必須 |
| SP-010 | 外部スクリプトからストーリーを開始できる | 必須 |
| SP-011 | ストーリー再生中はゲーム進行を一時停止できる（オプション） | 中 |

### 2.3 ストーリーデータ (StoryData)

| ID | 要件 | 優先度 |
|----|------|--------|
| SD-001 | ScriptableObjectとしてUnityエディタ内で編集可能 | 必須 |
| SD-002 | JSONファイルからのインポート/エクスポート対応 | 高 |
| SD-003 | 参考プロジェクトのJSON形式と互換性を持つ | 高 |
| SD-004 | ストーリーIDで一意に識別できる | 必須 |
| SD-005 | コマンドのリストを保持できる | 必須 |

### 2.4 ストーリーエディタ (StoryEditor)

| ID | 要件 | 優先度 |
|----|------|--------|
| SE-001 | Unityエディタウィンドウとして提供 | 必須 |
| SE-002 | コマンドの追加/削除/並び替えができる | 必須 |
| SE-003 | 各コマンドのパラメータを視覚的に編集できる | 必須 |
| SE-004 | プレビュー機能（エディタ内で再生確認） | 中 |
| SE-005 | JSONファイルのインポート/エクスポートボタン | 高 |
| SE-006 | 立ち絵/背景画像のサムネイルプレビュー | 中 |
| SE-007 | ドラッグ&ドロップでコマンド順序変更 | 中 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| ID | 要件 |
|----|------|
| NF-001 | タイプライター効果は60FPSで滑らかに動作する |
| NF-002 | 立ち絵フェード効果は60FPSで滑らかに動作する |
| NF-003 | 大量のセリフ（100行以上）でもパフォーマンス劣化しない |

### 3.2 保守性・再利用性

| ID | 要件 |
|----|------|
| NF-004 | 独立したUnityPackageとしてエクスポート可能な設計 |
| NF-005 | 他プロジェクトへの移植が容易な疎結合設計 |
| NF-006 | 名前空間 `RPGDefete.Story` で管理 |

### 3.3 拡張性

| ID | 要件 |
|----|------|
| NF-007 | 新しいコマンドタイプを追加しやすい設計 |
| NF-008 | カスタムUIスキンに差し替え可能 |

---

## 4. データ形式

### 4.1 ストーリースクリプトJSON形式

```json
{
  "id": "story_001",
  "script": [
    {
      "op": "bgm.play",
      "name": "peaceful_village",
      "loop": true,
      "volume": 0.7,
      "fade": 1000
    },
    {
      "op": "bg",
      "name": "village_square",
      "fade": 500
    },
    {
      "op": "say",
      "name": "村長",
      "portrait": "elder_normal",
      "portraitPosition": "left",
      "lines": [
        "ようこそ、旅の方。",
        "この村は平和な場所じゃ...",
        "しかし最近、不穏な噂が..."
      ]
    },
    {
      "op": "say",
      "name": "主人公",
      "portrait": "hero_serious",
      "portraitPosition": "right",
      "lines": [
        "噂...ですか？"
      ]
    },
    {
      "op": "end",
      "returnTo": "game"
    }
  ]
}
```

### 4.2 コマンド詳細

#### say（セリフ表示）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | string | ○ | キャラクター名 |
| portrait | string | - | 立ち絵リソース名 |
| portraitPosition | string | - | left / center / right (デフォルト: center) |
| portraitScale | float | - | 立ち絵スケール (デフォルト: 1.0) |
| lines | string[] | ○ | セリフ配列 |

#### bg（背景変更）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | string | ○ | 背景リソース名 |
| fade | int | - | フェード時間(ms) (デフォルト: 0) |

#### bgm.play（BGM再生）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | string | ○ | BGMリソース名 |
| loop | bool | - | ループ再生 (デフォルト: true) |
| volume | float | - | 音量 0-1 (デフォルト: 1.0) |
| fade | int | - | フェードイン時間(ms) (デフォルト: 0) |

#### bgm.stop（BGM停止）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| fade | int | - | フェードアウト時間(ms) (デフォルト: 0) |

#### se.play（効果音再生）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | string | ○ | SEリソース名 |
| volume | float | - | 音量 0-1 (デフォルト: 1.0) |

#### wait（待機）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| duration | int | ○ | 待機時間(ms) |

#### end（終了）
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| returnTo | string | - | 遷移先識別子 |

---

## 5. UI仕様

### 5.1 メッセージウィンドウレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ┌──────────┐                              ┌──────────┐    │
│  │          │                              │          │    │
│  │  立ち絵  │                              │  立ち絵  │    │
│  │  (左)    │                              │  (右)    │    │
│  │          │                              │          │    │
│  └──────────┘                              └──────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ キャラクター名                                       │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │ セリフテキストがここに表示される...                  │   │
│  │                                                     │   │
│  │                                        ▼ (進行マーク) │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 入力仕様

| 入力 | 動作 |
|------|------|
| 左クリック / Space / Enter | タイプライター中: 即時全文表示 / 完了後: 次のセリフへ |
| Escape | ストーリースキップ（オプション） |

---

## 6. ディレクトリ構造

```
Assets/
├── Scripts/
│   └── Story/
│       ├── Core/
│       │   ├── StoryPlayer.cs
│       │   ├── StoryCommand.cs
│       │   └── StoryData.cs
│       ├── Commands/
│       │   ├── SayCommand.cs
│       │   ├── BgCommand.cs
│       │   ├── BgmCommand.cs
│       │   ├── SeCommand.cs
│       │   ├── WaitCommand.cs
│       │   └── EndCommand.cs
│       ├── UI/
│       │   ├── MessageWindow.cs
│       │   └── TypewriterEffect.cs
│       └── Editor/
│           ├── StoryEditor.cs
│           └── StoryDataImporter.cs
├── Resources/
│   └── Story/
│       ├── Portraits/       # 立ち絵画像
│       ├── Backgrounds/     # 背景画像
│       ├── BGM/            # BGMファイル
│       └── SE/             # 効果音ファイル
└── Prefabs/
    └── Story/
        └── MessageWindow.prefab
```

---

## 7. 依存関係

| パッケージ | 用途 | 必須 |
|-----------|------|------|
| TextMeshPro | テキスト表示 | ○ |
| DOTween (推奨) | アニメーション | - |

---

## 8. 制約事項

- Unity 6000.0.46f1 以上
- Universal Render Pipeline (URP) 対応
- 既存の `UIManager.cs` との共存を考慮

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| StoryData | ストーリーの全データを保持するScriptableObject |
| StoryPlayer | ストーリーを再生するランタイムエンジン |
| StoryCommand | 個々のコマンド（say, bg等）の基底クラス |
| MessageWindow | セリフ表示用のUIコンポーネント |
| TypewriterEffect | 1文字ずつ表示するエフェクト |
